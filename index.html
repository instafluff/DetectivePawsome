<html>
  <head>
    <title>Detective Pawsome!</title>
    <script src="web/pinkfluffyunicorn.min.js"></script>
    <script src="web/eventemitter.js"></script>
    <script src="web/keyboard.js"></script>
    <script src="web/words.js"></script>
    <style>
      body { margin: 0; }
    </style>
  </head>
  <body>
    <div id="unicorn-display"></div>
    <script>
      const params = new URLSearchParams(location.search);
      window.WebFontConfig = {
          google: {
              families: ['Share Tech Mono'],
          },
          active() {
              CreateGame();
          },
      };

      /* eslint-disable */
      // include the web-font loader script
      (function() {
          const wf = document.createElement('script');
          wf.src = `${document.location.protocol === 'https:' ? 'https' : 'http'
          }://ajax.googleapis.com/ajax/libs/webfont/1/webfont.js`;
          wf.type = 'text/javascript';
          wf.async = 'true';
          const s = document.getElementsByTagName('script')[0];
          s.parentNode.insertBefore(wf, s);
      }());
      /* eslint-enabled */

      var bg2;
      const maxTextWidth = 18;
      const autoTextTime = 60;
      var displayTextCooldown = 0;
      var displayTextBuffer = "", textLines = 0;
      var textDisplay;
      var textPrompt, answer;
      var gameState = "";
      var textTimers = [];

      function Init() {
        Unicorn.Load( "bg1", "web/assets/bcg1.png" );
        Unicorn.Load( "bg2", "web/assets/bcg2.png" );

        Unicorn.AddOverlay( "bg1", "bg1", 0, 0 );
        bg2 = Unicorn.AddOverlay( "bg2", "bg2", 0, 0 );
        // Animate BG
        setInterval( () => {
          bg2.visible = !bg2.visible;
        }, 100 );

        textDisplay = Unicorn.AddText( "textDisplay", "", 190, 100, {
          fontFamily: "Share Tech Mono",
        } );
        answer = Unicorn.AddText( "answer", "", 190, 220, {
          fontFamily: "Share Tech Mono",
        } );
        textPrompt = Unicorn.AddText( "textPrompt", "_", 190, 100, {
          fontFamily: "Share Tech Mono",
        } );

        // Prompt Cursor
        setInterval( () => {
          if( textPrompt.text.endsWith( "_" ) ) {
            textPrompt.text = textPrompt.text.substring( 0, textPrompt.text.length - 1 );
          }
          else {
            textPrompt.text += "_";
          }
        }, 350 );
        keyboard.on( 'keydown', ( key ) => {
          switch( key ) {
          case "Backspace":
            typedword = typedword.substring( 0, typedword.length - 1 );
            break;
          case "Enter":
            if( checkWord( selectedWord, typedword ) ) {
              if( !isSolved ) {
                setSolved( "STREAMER" );
              }
            }
            else {
              incorrectAnswer();
            }
            typedword = "";
            break;
          default:
            if( typedword.length < maxTextWidth && key.match( /^[a-zA-Z]{1}$/ ) ) {
              typedword += key;
            }
            break;
          }
          textPrompt.text = typedword.split( "" ).join( "" );
          // console.log( typedword );
        } );
        
        // addDisplayText( "Testing a really long sentence to see if this works.\n" );

        setGameState( "Intro" );
      }

      function clearDisplayText() {
        textDisplay.text = "";
        displayTextBuffer = "";
        textPrompt.position.y = textDisplay.position.y;
      }

      function addDisplayText( text ) {
        displayTextBuffer += text.split( "\n" ).map( x => x.length > maxTextWidth ? x.replace(/(?!$|\n)([^\n]{18}(?!\n))/g, "$1\n") : x ).join( "\n" );
      }

      function delayedText( text, time ) {
        textTimers.push( setTimeout( () => {
          addDisplayText( text );
        }, time ) );
      }

      function setGameState( state ) {
        if( gameState !== state ) {
          gameState = state;
          textTimers.forEach( x => clearTimeout( x ) );
        }
        switch( state ) {
          case "Intro":
            clearDisplayText();
            delayedText( "Hello\nDetective Pawsome.", 1000 );
            delayedText( "\nPlease log in:", 3000 );
            delayedText( "\nYou got NOTHING?", 15000 );
            delayedText( "\nIt's NOTHING.", 20000 );
            delayedText( "\nReally.\nIt's NOTHING.", 30000 );
            delayedText( "\nJust type it.", 45000 );
            delayedText( "\nSeriously.", 50000 );
            delayedText( "\nYou there?", 60000 );
            delayedText( "\nHello?", 90000 );
            break;
          case "Intro2":
            clearDisplayText();
            delayedText( "You have\n1 message.\nOpen? yes/no", 1000 );
            delayedText( "\nType yes.", 15000 );
            delayedText( "\nTYPE yes.", 25000 );
            break;
          case "Intro3":
            clearDisplayText();
            delayedText( "\"Hey Paws,\nI've taken over\nyour computer.", 1000 );
            delayedText( "\nAnd the city.", 5000 );
            delayedText( "\nDon't stop me.", 7000 );
            delayedText( "\n-Catastrophe\"", 9000 );
            break;
          case "Pawzzle":
            clearDisplayText();
            delayedText( `Level ${gameLevel} of ${finalLevel}`, 500 );
            delayedText( "\nGuess Pawsword:", 1000 );
            break;
        }
        newWord( gameDifficulty );
      }

      function setSolved( user ) {
        isSolved = true;
        switch( gameState ) {
          case "Intro":
            setGameState( "Intro2" );
            break;
          case "Intro2":
            setGameState( "Intro3" );
            break;
          case "Intro3":
            setGameState( "Pawzzle" );
            break;
          case "Pawzzle":
            if( gameLevel < finalLevel ) {
              gameLevel++;
            }
            delayedText( "\nCongrats!", 0 );
            setTimeout( () => {
              setGameState( "Pawzzle" );
            }, 3000 );
            break;
        }
        console.log( "SOLVED BY " + user );
      }

      function incorrectAnswer() {
        switch( gameState ) {
          case "Intro":
            break;
          case "Intro2":
            setGameState( "Pawzzle" );
            break;
          case "Intro3":
            setGameState( "Pawzzle" );
            break;
          case "Pawzzle":
            break;
        }
      }

      function Update( timestamp, timeDiffInMs ) {
        // Add Update Loop
        // console.log( timestamp, timeDiffInMs );
        // Update Display Text
        if( displayTextBuffer && displayTextCooldown <= 0 ) {
          displayTextCooldown = autoTextTime;
          textDisplay.text += displayTextBuffer[ 0 ];
          displayTextBuffer = displayTextBuffer.substring( 1, displayTextBuffer.length );
          textLines = textDisplay.text.split( "\n" ).length;
          if( textLines > 4 ) {
            // Remove the first line and continue!
            var lines = textDisplay.text.split( "\n" );
            lines.shift();
            textDisplay.text = lines.join( "\n" );
            textLines--;
          }
          textPrompt.position.y = textDisplay.position.y + 25 * textLines;
        }
        if( displayTextCooldown > 0 ) {
          displayTextCooldown -= timeDiffInMs;
        }
      }

      function OnChatMessage( user, message, flags, self, extra ) {
        // Handle Chat Messages
        if( checkWord( selectedWord, message.split( " " )[ 0 ] ) ) {
          if( !isSolved && selectedWord === message.split( " " )[ 0 ] ) {
            setSolved( user )
          }
        }
      }

      function CreateGame() {
        Unicorn.Create( "unicorn-display", {
          width: 640,
          height: 360,
          background: params.get( "overlay" ) ? "transparent" : 0x777777,
          // background: "transparent",
          init: Init,
          update: Update,
          channel: params.get( "channel" ),
          // onCommand: OnChatCommand,
          onChat: OnChatMessage,
          // screenWalls: false, // Default: true
          // wallBottom: true,
          gravity: { x: 0, y: 0 },
        });
      }

      var gameDifficulty = 1;
      var gameLevel = 1;
      var finalLevel = 5;
      var isSolved = false;
      var words = wordList.split( "," ).filter( x => !x.includes( "-" ) );
      var selectedWord;
      var typedword = "";
      var revealedWord = "";
      // console.log( selectedWord );

      function newWord( difficulty ) {
        switch( gameState ) {
          case "Intro":
            selectedWord = "nothing";
            revealedWord = "";
            answer.visible = false;
            break;
          case "Intro2":
            selectedWord = "yes";
            revealedWord = "";
            answer.visible = false;
            break;
          case "Intro3":
            selectedWord = "captain";
            revealedWord = "";
            answer.visible = false;
            break;
          case "Pawzzle":
            var wordsByDifficulty = words.filter( x => x.length >= 4 && x.length <= ( difficulty + 5 ) );
            selectedWord = wordsByDifficulty[ Math.floor( Math.random() * wordsByDifficulty.length ) ];
            revealedWord = "_".repeat( selectedWord.length );
            answer.visible = true;
            break;
        }
        typedword = "";
        isSolved = false;
        answer.text = revealedWord.split( "" ).join( " " );
      }

      function checkWord( selectedWord, typedword ) {
        var word1 = selectedWord.toLowerCase();
        var word2 = typedword.toLowerCase();
        for( var i = 0; i < word1.length && i < word2.length; i++ ) {
          // console.log( i, word1[ i ], word1[ i ] );
          if( word1[ i ] === word2[ i ] ) {
            var parts = revealedWord.split( "" );
            parts[ i ] = word1[ i ];
            revealedWord = parts.join( "" );
            // console.log( revealedWord );
            answer.text = revealedWord.split( "" ).join( " " );
          }
        }
        return revealedWord === selectedWord;
      }
    </script>
  </body>
</html>
